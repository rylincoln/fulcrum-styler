<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <base target="_parent">
    <link href="http://www.nps.gov/lib/bootstrap/3.3.2/css/nps-bootstrap.css" rel="stylesheet">
    <style>
      html, body, #map {
        height: 100%;
        margin: 0;
        padding: 0;
        width: 100%;
      }
      #map {
        left: 0;
        position: absolute;
        top: 0;
      }
      .leaflet-container .leaflet-control-attribution {
        display:none !important;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <script>
      var $ = window.parent.$,
        NPMap = JSON.parse(JSON.stringify(parent.NPMap)),
        mapId = JSON.parse(JSON.stringify(parent.App)).mapId,
        heat = $('#fulcrum-heat');

      NPMap.hooks = {
        init: function(callback) {
          var $currentLat = $('#current-lat'),
            $currentLng = $('#current-lng'),
            $currentZoom = $('#current-zoom'),
            map = NPMap.config.L,
            zoom = $('#fulcrum-zoom, #navbar-title');

          function updateCurrent() {
            var latLng = map.getCenter();

            $currentLat.html(latLng.lat.toFixed(2));
            $currentLng.html(latLng.lng.toFixed(2));
            $currentZoom.html(map.getZoom());
          }

          zoom.on('click', function() {
            map.fitBounds(NPMap.config.overlays[0].L.getBounds());
            return false;

            // NPMap.config.overlays[0].L.eachLayer( function(layer){
            //   if (layer._latlng.lat === 0) {
            //     map.removeLayer(layer);
            //     layer.clearLayers
            //   }
            // });
          });

          map.on('moveend', updateCurrent);
          updateCurrent();
          callback();
        }
      };

          heat.on('click', function(){
          // add radius and intensity
            $.ajax({
              url: 'https://web.fulcrumapp.com/shares/' + mapId + '.geojson',
              type: 'GET',
              dataType: 'json',
              success: function(response){
                var features = response.features,
                  latLngs = [],
                  map = NPMap.config.L;

                for (var i = 0; i < features.length; i++) {
                  var coordinates = features[i].geometry.coordinates;
                  latLngs.push([
                    coordinates[1],
                    coordinates[0]
                  ]);
                };


                if (heat[0].checked) {
                 /* (c) 2014, Vladimir Agafonkin  https://github.com/mourner/simpleheat  */
              !function(){"use strict";function t(i){return this instanceof t?(this._canvas=i="string"==typeof i?document.getElementById(i):i,this._ctx=i.getContext("2d"),this._width=i.width,this._height=i.height,this._max=1,void this.clear()):new t(i)}t.prototype={defaultRadius:25,defaultGradient:{.4:"blue",.6:"cyan",.7:"lime",.8:"yellow",1:"red"},data:function(t){return this._data=t,this},max:function(t){return this._max=t,this},add:function(t){return this._data.push(t),this},clear:function(){return this._data=[],this},radius:function(t,i){i=i||15;var a=this._circle=document.createElement("canvas"),e=a.getContext("2d"),s=this._r=t+i;return a.width=a.height=2*s,e.shadowOffsetX=e.shadowOffsetY=200,e.shadowBlur=i,e.shadowColor="black",e.beginPath(),e.arc(s-200,s-200,t,0,2*Math.PI,!0),e.closePath(),e.fill(),this},gradient:function(t){var i=document.createElement("canvas"),a=i.getContext("2d"),e=a.createLinearGradient(0,0,0,256);i.width=1,i.height=256;for(var s in t)e.addColorStop(s,t[s]);return a.fillStyle=e,a.fillRect(0,0,1,256),this._grad=a.getImageData(0,0,1,256).data,this},draw:function(t){this._circle||this.radius(this.defaultRadius),this._grad||this.gradient(this.defaultGradient);var i=this._ctx;i.clearRect(0,0,this._width,this._height);for(var a,e=0,s=this._data.length;s>e;e++)a=this._data[e],i.globalAlpha=Math.max(a[2]/this._max,t||.05),i.drawImage(this._circle,a[0]-this._r,a[1]-this._r);var n=i.getImageData(0,0,this._width,this._height);return this._colorize(n.data,this._grad),i.putImageData(n,0,0),this},_colorize:function(t,i){for(var a,e=3,s=t.length;s>e;e+=4)a=4*t[e],a&&(t[e-3]=i[a],t[e-2]=i[a+1],t[e-1]=i[a+2])}},window.simpleheat=t}(),
              /*
               (c) 2014, Vladimir Agafonkin
               Leaflet.heat, a tiny and fast heatmap plugin for Leaflet.
               https://github.com/Leaflet/Leaflet.heat
              */
              L.HeatLayer=L.Class.extend({initialize:function(t,i){this._latlngs=t,L.setOptions(this,i)},setLatLngs:function(t){return this._latlngs=t,this.redraw()},addLatLng:function(t){return this._latlngs.push(t),this.redraw()},setOptions:function(t){return L.setOptions(this,t),this._heat&&this._updateOptions(),this.redraw()},redraw:function(){return!this._heat||this._frame||this._map._animating||(this._frame=L.Util.requestAnimFrame(this._redraw,this)),this},onAdd:function(t){this._map=t,this._canvas||this._initCanvas(),t._panes.overlayPane.appendChild(this._canvas),t.on("moveend",this._reset,this),t.options.zoomAnimation&&L.Browser.any3d&&t.on("zoomanim",this._animateZoom,this),this._reset()},onRemove:function(t){t.getPanes().overlayPane.removeChild(this._canvas),t.off("moveend",this._reset,this),t.options.zoomAnimation&&t.off("zoomanim",this._animateZoom,this)},addTo:function(t){return t.addLayer(this),this},_initCanvas:function(){var t=this._canvas=L.DomUtil.create("canvas","leaflet-heatmap-layer leaflet-layer"),i=this._map.getSize();t.width=i.x,t.height=i.y;var a=this._map.options.zoomAnimation&&L.Browser.any3d;L.DomUtil.addClass(t,"leaflet-zoom-"+(a?"animated":"hide")),this._heat=simpleheat(t),this._updateOptions()},_updateOptions:function(){this._heat.radius(this.options.radius||this._heat.defaultRadius,this.options.blur),this.options.gradient&&this._heat.gradient(this.options.gradient),this.options.max&&this._heat.max(this.options.max)},_reset:function(){var t=this._map.containerPointToLayerPoint([0,0]);L.DomUtil.setPosition(this._canvas,t);var i=this._map.getSize();this._heat._width!==i.x&&(this._canvas.width=this._heat._width=i.x),this._heat._height!==i.y&&(this._canvas.height=this._heat._height=i.y),this._redraw()},_redraw:function(){var t,i,a,e,s,n,h,o,r,_=[],d=this._heat._r,l=this._map.getSize(),m=new L.LatLngBounds(this._map.containerPointToLatLng(L.point([-d,-d])),this._map.containerPointToLatLng(l.add([d,d]))),c=void 0===this.options.maxZoom?this._map.getMaxZoom():this.options.maxZoom,u=1/Math.pow(2,Math.max(0,Math.min(c-this._map.getZoom(),12))),g=d/2,f=[],p=this._map._getMapPanePos(),v=p.x%g,w=p.y%g;for(t=0,i=this._latlngs.length;i>t;t++)m.contains(this._latlngs[t])&&(a=this._map.latLngToContainerPoint(this._latlngs[t]),s=Math.floor((a.x-v)/g)+2,n=Math.floor((a.y-w)/g)+2,r=(this._latlngs[t].alt||1)*u,f[n]=f[n]||[],e=f[n][s],e?(e[0]=(e[0]*e[2]+a.x*r)/(e[2]+r),e[1]=(e[1]*e[2]+a.y*r)/(e[2]+r),e[2]+=r):f[n][s]=[a.x,a.y,r]);for(t=0,i=f.length;i>t;t++)if(f[t])for(h=0,o=f[t].length;o>h;h++)e=f[t][h],e&&_.push([Math.round(e[0]),Math.round(e[1]),Math.min(e[2],1)]);this._heat.data(_).draw(),this._frame=null},_animateZoom:function(t){var i=this._map.getZoomScale(t.zoom),a=this._map._getCenterOffset(t.center)._multiplyBy(-i).subtract(this._map._getMapPanePos());this._canvas.style[L.DomUtil.TRANSFORM]=L.DomUtil.getTranslateString(a)+" scale("+i+")"}}),L.heatLayer=function(t,i){return new L.HeatLayer(t,i)};
           
                var heated = L.heatLayer(latLngs,{radius:25, blur:15}).addTo(map);
                  map.removeLayer(NPMap.config.overlays[0].L);
                  NPMap.config.overlays[0].visible = false;
                  map.addLayer(heated);
                  NPMap.config.overlays[1] = heated;

                  function blur(){
                    heated.setOptions({blur: parseInt($('#blur')[0].value)});
                  }
                  function radius(){
                    heated.setOptions({radius: parseInt($('#radius')[0].value)});
                  }

                  $('#heat-options').css('display','block');
                  $('input[type=range]').on('input', function (heated) {
                    if (this.id === 'radius'){
                      radius();
                    } else {
                      blur();
                    }
                  });

                  var datum = {
                    'description': 'the mapping config',
                    'public': true,
                    'files': {
                      'app.js': {
                        'content': 'var NPMap = '+ NPMap.config + ';' +
                        'var s = document.createElement(\"script\");'+
                        's.src = \"http://www.nps.gov/npmap/npmap.js/2.0.0/npmap-bootstrap.min.js\";'+
                        'document.body.appendChild(s);'
                      }
                    }
                  };

                  parent.FulcrumStyler.showLoading();
                  // $this.blur();

                  // $.ajax({
                  //   url: 'https://api.github.com/gists',
                  //   type: 'POST',
                  //   dataType: 'json',
                  //   data: JSON.stringify(datum),
                  //   public: false
                  // }).success( function(response) {
                  //   window.App.id = response.id;
                  //   console.log(response);
                  //   parent.FulcrumStyler.hideLoading();

                  //   // updateSaveStatus(response.modified);
                  //   alertify.success('Your map was saved!');
                  //   success = true;
                    
                  //   if (typeof callback === 'function') {
                  //     callback(success);
                  //   }
                  // }).error( function(e) {
                  //   var error = 'Sorry, there was an unhandled error while saving your map. Please try again.';
                  //   alertify.error(error);
                  // });
          
                  //disable popups
                  //disable style
                  //disable basemaps
                } else {
                  parent.FulcrumStyler.updateMap();
                  $('#heat-options').css('display','none');
                }
              }
            });
          });

      if (NPMap.baseLayers === undefined || NPMap.baseLayers.length === 0){
        NPMap.baseLayers = ['cartodb-positron']; 
      };
      
      (function() {
        var s = document.createElement('script'); 
        s.src = 'http://www.nps.gov/lib/npmap.js/2.0.0/npmap-bootstrap.js';
        document.body.appendChild(s);
      })();
    </script>
  </body>
</html>
